name: ðŸš€ Release & Docker Build

on:
  push:
    branches: [main]
    paths-ignore:
      - '.github/**'
      - '*.md'
      - 'docs/**'
  pull_request:
    branches: [main]
    paths:
      - 'Dockerfile'
      - 'src/**'
      - 'package*.json'
      - 'tsconfig.json'
      - '.dockerignore'
  workflow_dispatch:
    inputs:
      force-release:
        description: 'force create release'
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write
  security-events: write

jobs:
  # Release nur auf main branch push (nicht PRs)
  release:
    name: Create Semantic Release
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    uses: bauer-group/automation-templates/.github/workflows/modules-semantic-release.yml@main
    with:
      target-branch: 'main'
      dry-run: false
      force-release: ${{ inputs.force-release || false }}
    secrets: inherit

  # Docker Build fÃ¼r Release (nach erfolgreichem Release)
  docker-build-release:
    name: Build & Push Docker Image (Release)
    needs: release
    if: needs.release.outputs.release-created == 'true'
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      publish-to: 'both'
      ghcr-image-name: 'bauer-group/ghost-bunnycdn-connector'
      docker-image-name: 'bauergroup/ghost-bunnycdn-connector'

      # Version vom erstellten Release Tag verwenden
      image-tags: |
        type=raw,value=${{ needs.release.outputs.version }}
        type=raw,value=latest

      update-dockerfile-version: true
      version-from-dockerfile: false
      semver-from-dockerfile: false
      auto-tags: false  # Wir setzen Tags manuell

      dockerfile-path: './Dockerfile'
      docker-context: '.'
      platforms: 'linux/amd64'

      push: true

      security-scan: true
      security-fail-on: 'CRITICAL'
      generate-sbom: true
      sync-dockerhub-readme: true
    secrets: inherit

  # Docker Build fÃ¼r PRs (nur validieren, nicht pushen)
  docker-build-pr:
    name: Build Docker Image (PR Validation)
    if: github.event_name == 'pull_request'
    uses: bauer-group/automation-templates/.github/workflows/docker-build.yml@main
    with:
      publish-to: 'ghcr'
      ghcr-image-name: 'bauer-group/ghost-bunnycdn-connector'

      auto-tags: true
      dockerfile-path: './Dockerfile'
      docker-context: '.'
      platforms: 'linux/amd64'

      push: false  # Nur bauen, nicht pushen

      security-scan: true
      security-fail-on: 'CRITICAL'
    secrets: inherit
